# Respond OR scripts

Respond OR related scripts. Sample of input files are available in [Google Drive](https://drive.google.com/drive/folders/1eOyR4GRGnSqLTzOl_rRk7EaK216bSXWH)

## Prerequisites

These software are required:

* Python >= 3.8
* PostgreSQL == 12 (for graph generation)
* PostGIS == 3.0 (for graph generation)

These files are required as input for each map/location:

1. OpenStreetMap.org graph file (`*.pycgr`/`*.pycgrc`) is generated by [OsmToRoadGraph](https://github.com/AndGem/OsmToRoadGraph). Example: [data/graph.pycgrc](data/graph.pycgrc)
2. Networkx JSON file is also generated by OsmToRoadGraph (along with `*.pycgr`/`*.pycgrc`)
3. Point of Interests location file (`*.csv`) where each rows contain `name,type,lat,lon`. Example: [data/locations.csv](data/locations.csv)
4. Risk layer image (`*.png`) from [INARISK.](http://service1.inarisk.bnpb.go.id:6080/arcgis/rest/services/inaRISK) along with some samples of pixel-coordinates pairs of the image (eg. `[199, 151] => [-6.124142, 106.656685]`). Example: [data/risk_layer.png](data/risk_layer.png)

## Preparing data

Generating `*.pycgrc` file and networkx JSON graph using [osmconvert64](http://m.m.i24.cc/osmconvert64) and [OsmToRoadGraph](https://github.com/AndGem/OsmToRoadGraph):

```
# convert pbf to osm file
~/osmconvert64 jakarta.osm.pbf -o=jakarta.osm

# generate pycgrc and networkx json from osm file
python run.py -f jakarta.osm -n c -c --networkx

# the result will be jakarta.pycgrc and jakarta_contracted.json
```

## Setup

Setup steps:
1. Rename `config.ini.example` to `config.ini` and ajdust PostgreSQL config values
2. Install Python dependencies `pip install -r requirements.txt`

## Running

### Graph generation

The main script for this is `osm_graph.py`. Steps to use it:

* Generate `*.pycgrc` and networkx adjajency `json` using [AndGem/OsmToRoadGraph](https://github.com/AndGem/OsmToRoadGraph). 
* Create csv files that contains POI details (see example `data/locations.csv`) 
* Modify `main` block in `osm_graph.py` to pass correct files to the functions
* Run `python osm_graph.py`

or import and run the necessary functions:

```
python -c "from osm_graph import *; create_subgraph('data/jakarta/jakarta_locations.csv', 'data/jakarta/jakarta_contracted.json', 'data/jakarta/jakarta_subnetwork.json')"
```

### Network risk generation

The main script for this is `network_risk.py`. Steps to use it:

* Obtain risk layer image from [INARISK](http://www.arcgis.com/home/webmap/viewer.html?url=http%3A%2F%2Fservice1.inarisk.bnpb.go.id%3A6080%2Farcgis%2Frest%2Fservices%2FinaRISK%2Flayer_bahaya_banjir%2FImageServer&source=sd). Make sure that the background color is white (`RGBA(255, 255, 255, 255)`) to prevent wrong risk calculation. The example will be like `data/risk_layer.png`
* Estimate min 2 samples of the x/y-lat/lon pairs for conversion (required as one of input in `network_risk.py`)
* Prepare the `pycgr/pycgrc` file that corresponds to the layer image
* Modify `main` block in `network_risk.py` to pass correct files to the functions
* Run `python network_risk.py`

> Use more than 2 samples to test/validate the x/y to lat/lon extrapolation

### End-to-end

Modify `input.json` with your input file and run `python main.py input.json`:

```
{
    "name": "jakarta",
    "output_dir": "data/jakarta",
    "network_pycgr_file": "data/jakarta/jakarta.pycgrc",
    "poi_file": "data/jakarta/jakarta_locations.csv",
    "network_json_file": "data/jakarta/jakarta_contracted.json",    
    "risk_layer_file": "data/jakarta/jakarta_flood_risk_layer_inarisk.png",
    "risk_coordinates_samples": [
        [[199, 151], [-6.124142, 106.656685]],
        [[72, 392], [-6.288732, 106.569526]],
        [[355, 463], [-6.336779, 106.763544]]
    ]
}
```

Input fields:

* `name`: name of the area. Will be used as the base name of table and output files
* `output_dir`: relative/absolute path of the output directory
* `network_pycgr_file`: relative/absolute path of the original pycgr/pycgrc file
* `poi_file`: relative/absolute path of the original point of interests CSV file
* `network_json_file`: relative/absolute path of the original networkx JSON file
* `risk_layer_file`: relative/absolute path of the original risk layer image file from INARISK
* `risk_coordinates_samples`: array of array of risk layer pixel-coordinates pairs (min. 2 pairs)